#! /usr/bin/env ruby
# coding: utf-8

begin
  require 'osx/cocoa'
  OSX.require_framework 'Quartz'
rescue LoadError
  abort "RubyCocoa is needed"
end

if ARGV.length < 2
  abort "#{$0} INPUT.pdf OUTPUT.pdf"
end
src_path, dest_path = ARGV[0,2]

unless File.file? src_path
  if File.exists? src_path
    abort "can't open the file: #{src_path}"
  else
    abort "file not found: #{src_path}"
  end
end

if File.exist? dest_path
  abort "the file already exists: #{dest_path}"
end

src_url = OSX.CFURLCreateFromFileSystemRepresentation(OSX::KCFAllocatorDefault, src_path, src_path.bytesize, false)
dest_url = OSX.CFURLCreateFromFileSystemRepresentation(OSX::KCFAllocatorDefault, ARGV[1], ARGV[1].bytesize, false)
unless src_pdf = OSX.CGPDFDocumentCreateWithURL(src_url)
  abort "not a PDF file: #{src_path}"
end

if OSX.CGPDFDocumentIsEncrypted(src_pdf)
  abort "the src PDF file is encrypted: #{src_path}" <<
    "Sorry, encrypted PDF has not been supported yet"
end

unless OSX.CGPDFDocumentIsUnlocked(src_pdf)
  abort "Can't unlock the PDF file: #{src_path}"
end

src_pages = OSX.CGPDFDocumentGetNumberOfPages(src_pdf)
if src_pages == 0
  abort "the PDF file doesn't have any pages: #{src_path}"
end

info_dict = OSX.CFDictionaryCreateMutable(
  nil, 0,
  OSX::KCFTypeDictionaryKeyCallBacks,
  OSX::KCFTypeDictionaryValueCallBacks)
#OSX.CFDictionarySetValue(info_dict, OSX::KCGPDFContextTitle,   "title"); # FIXME
#OSX.CFDictionarySetValue(info_dict, OSX::KCGPDFContextCreator, "creator"); # FIXME
dest_pdf = OSX.CGPDFContextCreateWithURL(dest_url, nil, info_dict)

src_pages.times do |page_number|
  page = OSX.CGPDFDocumentGetPage(src_pdf, page_number + 1)
  page_rect = OSX.CGPDFPageGetBoxRect(page, OSX::KCGPDFMediaBox)

  page_rect.size.width /= 2

  # draw half-left of the page
  OSX.CGContextBeginPage(dest_pdf, page_rect)
  OSX.CGContextDrawPDFPage(dest_pdf, page)
  OSX.CGContextEndPage(dest_pdf)

  # draw half-right of the page
  OSX.CGContextBeginPage(dest_pdf, page_rect)
  OSX.CGContextSaveGState(dest_pdf)
  OSX.CGContextTranslateCTM(dest_pdf, -page_rect.size.width, 0)
  OSX.CGContextDrawPDFPage(dest_pdf, page)
  OSX.CGContextRestoreGState(dest_pdf)
  OSX.CGContextEndPage(dest_pdf)
end

# vim:set fileencoding=utf-8 tabstop=8 shiftwidth=2 expandtab :
